<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agenda Alumni ‚Äì multi-√©coles</title>

<style>
:root{
  --bg:#f7f8fb; --card:#fff; --text:#111; --muted:#555; --brand:#4338ca;
  --chip-bg:#eef2ff; --chip:#1e3a8a; --shadow:0 1px 6px rgba(0,0,0,.06);
  --border:#ccd2e4;
}
html,body{background:var(--bg); color:var(--text)}
body{font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0}
.wrap{max-width:1100px; margin:0 auto; padding:0 16px 24px}

h1{font-size:24px; margin:16px 0}

/* Filtres : sticky desktop, non-sticky mobile/paysage/hauteur faible */
.filters{
  position:sticky; top:0; z-index:10;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  padding:10px 16px; margin:0 -16px 8px;
  background:#f7f8fbcc; backdrop-filter: blur(8px);
  border-bottom:1px solid #e5e8f3;
}
@media (max-width: 640px),
       (max-height: 520px),
       (orientation: landscape) and (max-height: 600px){
  .filters{ position:static; backdrop-filter:none; background:transparent; border-bottom:none; margin:0 0 8px; padding:10px 0 }
}

.input, select{
  font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
  background:var(--card); color:var(--text);
}
select:disabled{opacity:.55}
label.inline{display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted)}

.section-title{
  margin:18px 0 8px; color:#374151; font-size:20px; font-weight:800; text-transform:capitalize;
}

/* Cartes compactes et robustes */
.card{
  background:var(--card); border-radius:14px; padding:12px 14px; margin:12px 0;
  box-shadow:var(--shadow); display:flex; gap:12px; align-items:center; min-height:84px;
  transition:transform .12s ease, box-shadow .12s ease;
  overflow:hidden; word-break:break-word; overflow-wrap:anywhere;
}
.card:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08) }

.thumb{
  width:160px; height:100px; border-radius:10px; object-fit:cover; flex:0 0 auto;
}
@media (max-width:640px){ .thumb{ width:96px; height:64px } }
@media (max-width:420px){ .thumb{ display:none } }

.card .main{display:flex; align-items:center; gap:12px; width:100%}
.card .text{flex:1 1 auto; min-width:0}

.meta{font-size:13px; color:var(--muted); margin:2px 0 4px}
.badge{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px;
       background:var(--chip-bg); color:var(--chip); font-size:12px; font-weight:600}
.school{margin-left:8px}
.title{font-weight:800; line-height:1.25; margin:0 0 2px; display:flex; flex-wrap:wrap; gap:8px}
.title > strong{
  font-size:16px; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
}
@media (max-width:640px){ .title > strong{ font-size:15px; -webkit-line-clamp:2; line-clamp:2 } }

.desc{
  font-size:14px; line-height:1.35; color:var(--muted);
  display:-webkit-box; -webkit-line-clamp:3; line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
}
@media (max-width:640px){ .desc{ -webkit-line-clamp:2; line-clamp:2 } }

.btn{
  display:inline-block; background:var(--brand); color:#fff;
  padding:8px 12px; border-radius:10px; font-weight:700; font-size:13px;
  text-decoration:none; white-space:nowrap; margin-top:0;
}
.btn:focus-visible{outline:2px solid #6d64ff}

/* Fl√®che mobile */
.icon-btn{
  display:none;
  width:36px; height:36px; border-radius:10px; background:var(--brand);
  color:#fff; align-items:center; justify-content:center; text-decoration:none; flex:0 0 auto;
}
.icon-btn svg{width:18px; height:18px; display:block}
@media (max-width:640px){
  .btn{display:none}
  .icon-btn{display:inline-flex}
}
</style>

<div class="wrap">
  <h1>Agenda Alumni</h1>

  <div class="filters">
    <input id="search" class="input" placeholder="Rechercher (titre, description)" style="flex:1;min-width:220px">
    <select id="school"><option value="">üè´ Toutes les √©coles</option></select>
    <select id="city"><option value="">üìç Toutes les villes</option></select>
    <label class="inline"><input type="checkbox" id="onlineOnly"> En ligne uniquement</label>
  </div>

  <div id="list">Chargement‚Ä¶</div>
</div>

<script>
// ------- Helpers -------
const $ = s => document.querySelector(s);
function cleanHtml(s){ return (s||'').replace(/<[^>]*>/g,''); }
function toTitleCaseCity(s){
  if(!s) return '';
  let t=s.toString().trim().toLowerCase();
  return t.split(/\s+/).map(part=>part.split('-').map(p=>p? p[0].toUpperCase()+p.slice(1):p).join('-')).join(' ');
}
function normCity(s){ return toTitleCaseCity(s); }

// ------- Load -------
async function load(){
  const r = await fetch('events.json',{cache:'no-store'});
  const data = await r.json();
  window.allEvents = data;
  populateFilters(data);
  renderFiltered();

  // Au 1er chargement : se placer sur "aujourd'hui" si pr√©sent
  const todayISO = new Date().toISOString().slice(0,10);
  requestAnimationFrame(()=>scrollToSectionKey(todayISO));
}

// ------- Filters UI -------
function populateFilters(data){
  const schools=[...new Set(data.map(e=>e.school).filter(Boolean))].sort();
  const cities=[...new Set(data.map(e=>normCity(e.city)).filter(Boolean))].sort();
  const sSel=$('#school'), cSel=$('#city'), q=$('#search'), chk=$('#onlineOnly');
  schools.forEach(x=>sSel.innerHTML+=`<option>${x}</option>`);
  cities.forEach(c=>cSel.innerHTML+=`<option>${c}</option>`);
  [sSel,cSel,q,chk].forEach(el=>el.addEventListener('input', onFiltersChange));
  chk.addEventListener('change', onFiltersChange);
  if(chk.checked){ cSel.disabled=true; cSel.value=''; }
}

function onFiltersChange(){
  // ancre jour visible avant re-render
  const prevKey = getTopSectionKey();

  const chk=$('#onlineOnly'), cSel=$('#city');
  if(chk.checked){ cSel.disabled=true; cSel.value=''; } else { cSel.disabled=false; }

  renderFiltered();

  // restaurer exactement le m√™me jour (si toujours pr√©sent)
  requestAnimationFrame(() => {
    requestAnimationFrame(() => scrollToSectionKey(prevKey));
  });
}

// ------- Filtering (>= aujourd'hui) -------
function renderFiltered(){
  const q=($('#search').value||'').toLowerCase();
  const school=$('#school').value;
  const citySel=$('#city').value;
  const onlineOnly=$('#onlineOnly').checked;

  const today = new Date(); today.setHours(0,0,0,0);

  const filtered = window.allEvents.filter(e=>{
    if (e.start) {
      const d = new Date(e.start);
      if (d < today) return false; // exclut tout avant aujourd'hui
    }
    const hay = (`${e.title||''} ${cleanHtml(e.description||'')} ${e.location||''}`).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(school && e.school!==school) return false;
    if(onlineOnly && !e.isOnline) return false;
    if(!onlineOnly && citySel && normCity(e.city)!==citySel) return false;
    return true;
  });

  renderGrouped(filtered);
}

// ------- Grouping by day (adds data-key) -------
function renderGrouped(rows){
  const list=$('#list');
  if(!rows.length){ list.innerHTML='<p style="color:#666">Aucun √©v√©nement trouv√©.</p>'; return; }

  const groups={};
  for(const d of rows){
    const key = d.start ? new Date(d.start).toISOString().slice(0,10) : 'sans-date';
    (groups[key] ||= []).push(d);
  }
  const days=Object.keys(groups).sort();

  list.innerHTML = days.map(day=>{
    const title = (day==='sans-date')
      ? 'Sans date'
      : new Date(day).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const cards = groups[day].map(cardHtml).join('');
    return `<h2 class="section-title" data-key="${day}">${title}</h2>${cards}`;
  }).join('');
}

// ------- Anchor helpers (by key) -------
function getTopSectionKey(){
  const heads = [...document.querySelectorAll('.section-title')];
  if (!heads.length) return null;
  let closest = null, closestY = Infinity, lastAbove = null;
  for (const h of heads) {
    const y = h.getBoundingClientRect().top;
    if (y >= 0 && y < closestY) { closest = h; closestY = y; }
    if (y < 0) lastAbove = h;
  }
  const anchor = closest || lastAbove || heads[0];
  return anchor ? (anchor.dataset.key || anchor.textContent.trim()) : null;
}

function scrollToSectionKey(key){
  if (!key) return;
  let target = document.querySelector(`.section-title[data-key="${key}"]`);
  if (!target) {
    target = [...document.querySelectorAll('.section-title')]
      .find(h => h.textContent.trim() === key);
  }
  if (target) target.scrollIntoView({ behavior: 'instant', block: 'start' });
}

// ------- Card renderer (compact, CTA right / arrow mobile) -------
function cardHtml(d){
  const start = d.start ? new Date(d.start).toLocaleString('fr-FR',
    {weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
  const city = normCity(d.city);
  const badge = d.isOnline ? `<span class="badge">En ligne</span>` : `<span class="badge">üìç ${city||''}</span>`;
  const img = d.imageUrl ? `<img class="thumb" loading="lazy" src="${d.imageUrl}" alt="">` : '';

  // Description : retire l'adresse en t√™te, ne garde que le texte utile
  let rawDesc = cleanHtml(d.description||'').replace(/\s+/g,' ').trim();
  rawDesc = rawDesc.replace(/^((?:[A-Z√â√à√Ä][^.!?]{0,120}\d{2,5}.*?[,;]?\s*){0,2})/i,'');
  rawDesc = rawDesc.replace(/^(?:H[E√â]C Alumni|H√¥tel|Palais|Cercle|Rue|Avenue|Boulevard|Place|9bis|L‚Äô|Le\s|La\s)[^.!?]{0,120}/i,'');
  const desc = rawDesc.slice(0,220);

  const url = d.url;

  return `
    <article class="card">
      ${img}
      <div class="main">
        <div class="text">
          <div class="meta">${badge}${start?` ¬∑ ${start}`:''}</div>
          <div class="title"><strong>${d.title}</strong><span class="badge school">${d.school}</span></div>
          <p class="desc">${desc}‚Ä¶</p>
        </div>
        <a class="btn" href="${url}" target="_blank" rel="noopener">En savoir plus</a>
        <a class="icon-btn" href="${url}" target="_blank" rel="noopener" aria-label="Ouvrir l‚Äô√©v√©nement">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
    </article>`;
}

load();
</script>
