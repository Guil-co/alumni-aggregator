<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agenda Alumni ‚Äì multi-√©coles</title>

<style>
:root{
  --bg:#f7f8fb; --card:#fff; --text:#111; --muted:#555; --brand:#4338ca;
  --chip-bg:#eef2ff; --chip:#1e3a8a; --shadow:0 1px 6px rgba(0,0,0,.06);
  --border:#ccd2e4;
}
html,body{background:var(--bg); color:var(--text)}
body{font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0}
.wrap{max-width:1100px; margin:0 auto; padding:0 16px 24px}

h1{font-size:24px; margin:16px 0}

/* sticky desktop, non-sticky mobile */
.filters{
  position:sticky; top:0; z-index:10;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  padding:10px 16px; margin:0 -16px 8px;
  background:#f7f8fbcc; backdrop-filter: blur(8px);
  border-bottom:1px solid #e5e8f3;
}
@media (max-width: 640px){
  .filters{ position:static; backdrop-filter:none; background:transparent; border-bottom:none; margin:0 0 8px; padding:10px 0 }
}

.input, select{
  font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
  background:var(--card); color:var(--text);
}
select:disabled{opacity:.55}
label.inline{display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted)}

.section-title{
  margin:18px 0 8px; color:#374151; font-size:15px; font-weight:700; text-transform:capitalize;
}

.card{
  background:var(--card); border-radius:14px; padding:14px; margin:12px 0;
  box-shadow:var(--shadow); display:flex; gap:14px; align-items:flex-start; min-height:108px;
  transition:transform .12s ease, box-shadow .12s ease;
}
.card:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08) }

.thumb{width:160px; height:100px; border-radius:10px; object-fit:cover; flex-shrink:0}
@media (max-width:360px){ .thumb{display:none} }

.meta{font-size:13px; color:var(--muted); margin:4px 0}
.badge{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px;
       background:var(--chip-bg); color:var(--chip); font-size:12px; font-weight:600}
.school{margin-left:8px}
.title{font-weight:800; line-height:1.25; margin:4px 0 2px; display:flex; flex-wrap:wrap; gap:8px}
.title > strong{font-size:16px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
.desc{font-size:14px; line-height:1.35; color:var(--muted); display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden}
.btn{display:inline-block; margin-top:10px; background:var(--brand); color:#fff;
     padding:10px 14px; border-radius:10px; font-weight:700; font-size:14px; text-decoration:none}
.btn:focus-visible{outline:2px solid #6d64ff}
</style>

<div class="wrap">
  <h1>Agenda Alumni</h1>

  <div class="filters">
    <input id="search" class="input" placeholder="Rechercher (titre, description)" style="flex:1;min-width:220px">
    <select id="school"><option value="">üè´ Toutes les √©coles</option></select>
    <select id="city"><option value="">üìç Toutes les villes</option></select>
    <label class="inline"><input type="checkbox" id="onlineOnly"> En ligne uniquement</label>
  </div>

  <div id="list">Chargement‚Ä¶</div>
</div>

<script>
// --- helpers ---
const $ = sel => document.querySelector(sel);
function cleanHtml(s){ return (s||'').replace(/<[^>]*>/g,''); }
function toTitleCaseCity(s){
  if(!s) return '';
  let t = s.toString().trim().toLowerCase();
  return t.split(/\s+/).map(part =>
    part.split('-').map(p => p ? p[0].toUpperCase()+p.slice(1) : p).join('-')
  ).join(' ');
}
function normCity(s){ return toTitleCaseCity(s); }

async function load(){
  const r = await fetch('events.json', {cache:'no-store'});
  const data = await r.json();
  window.allEvents = data;
  populateFilters(data);
  renderFiltered();
}

function populateFilters(data){
  const schools=[...new Set(data.map(e=>e.school).filter(Boolean))].sort();
  const cities=[...new Set(data.map(e=>normCity(e.city)).filter(Boolean))].sort();

  const sSel=$('#school'), cSel=$('#city'), q=$('#search'), chk=$('#onlineOnly');
  schools.forEach(x=>sSel.innerHTML+=`<option>${x}</option>`);
  cities.forEach(c=>cSel.innerHTML+=`<option>${c}</option>`);

  [sSel,cSel,q,chk].forEach(el=>el.addEventListener('input', onFiltersChange));
  chk.addEventListener('change', onFiltersChange);

  if(chk.checked){ cSel.disabled=true; cSel.value=''; }
}

function onFiltersChange(){
  const chk=$('#onlineOnly'), cSel=$('#city');
  if(chk.checked){ cSel.disabled=true; cSel.value=''; } else { cSel.disabled=false; }
  renderFiltered();
}

function renderFiltered(){
  const q=($('#search').value||'').toLowerCase();
  const school=$('#school').value;
  const citySel=$('#city').value; // d√©j√† normalis√©
  const onlineOnly=$('#onlineOnly').checked;

  const filtered = window.allEvents.filter(e=>{
    const hay = (`${e.title||''} ${cleanHtml(e.description||'')} ${e.location||''}`).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(school && e.school!==school) return false;
    if(onlineOnly && !e.isOnline) return false;
    if(!onlineOnly && citySel && normCity(e.city)!==citySel) return false;
    return true;
  });

  renderGrouped(filtered);
}

/* ---------- Groupement par jour ---------- */
function renderGrouped(rows){
  const list=$('#list');
  if(!rows.length){ list.innerHTML='<p style="color:#666">Aucun √©v√©nement trouv√©.</p>'; return; }

  // group by YYYY-MM-DD
  const groups = {};
  for(const d of rows){
    const key = d.start ? new Date(d.start).toISOString().slice(0,10) : 'sans-date';
    (groups[key] ||= []).push(d);
  }

  const days = Object.keys(groups).sort(); // asc

  const sections = days.map(day=>{
    const title = (day==='sans-date')
      ? 'Sans date'
      : new Date(day).toLocaleDateString('fr-FR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    const cards = groups[day].map(cardHtml).join('');
    return `<h3 class="section-title">${title}</h3>${cards}`;
  }).join('');

  list.innerHTML = sections;
}

function cardHtml(d){
  const start = d.start ? new Date(d.start).toLocaleString('fr-FR',
    {weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
  const city = normCity(d.city);
  const badge = d.isOnline ? `<span class="badge">En ligne</span>` : `<span class="badge">üìç ${city||''}</span>`;
  const img = d.imageUrl ? `<img class="thumb" loading="lazy" src="${d.imageUrl}" alt="">` : '';
  const desc = cleanHtml(d.description||'').slice(0,260);

  return `
    <article class="card">
      ${img}
      <div>
        <div class="meta">${badge}${start?` ¬∑ ${start}`:''}</div>
        <div class="title"><strong>${d.title}</strong><span class="badge school">${d.school}</span></div>
        <div class="meta">${d.location||''}</div>
        <p class="desc">${desc}‚Ä¶</p>
        <a class="btn" href="${d.url}" target="_blank" rel="noopener">En savoir plus</a>
      </div>
    </article>`;
}

load();
</script>
